<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: #f3f7f4;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2d572c;
            margin-bottom: 20px;
        }

        .filters {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: center;
            gap: 15px; 
        }

        .filters label {
            font-weight: bold;
            color: #555;
        }

        .filters input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            color: #333;
        }

    .filters button {
        background: #4CAF50; 
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Sarabun', sans-serif;
        font-size: 16px;
        transition: background-color 0.2s ease;
    }

    .filters button:hover {
        background-color: #45a049;
    }

    .filters button.active {
        background-color: #2e7d32; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

        .bill {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 450px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative; 
        }

    /* Style for completed orders */
    .bill.completed {
        background: #e8f5e9; 
        border-color: #a5d6a7; 
    }
    .bill.completed h3 {
        color: #2e7d32; 
    }
    .bill.completed .bill-total {
        color: #2e7d32;
    }
    .bill.completed .status-indicator {
        background: #4caf50; 
        color: white;
    }

    /* Style for pending orders */
    .bill.pending {
        background: #fff3e0; 
        border-color: #ffcc80; 
    }
    .bill.pending h3 {
        color: #ef6c00; 
    }
    .bill.pending .bill-total {
        color: #ef6c00;
    }
    .bill.pending .status-indicator {
        background: #ff9800; 
        color: white;
    }

        .bill h3 {
            margin: 0 0 15px;
            font-size: 20px;
            color: #2d572c;
            text-align: center;
        }

        .bill-info {
            font-size: 0.95em;
            margin-bottom: 15px;
            line-height: 1.6;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        .bill-info div {
            display: flex;
            justify-content: space-between;
        }

        .bill-info span:first-child {
            font-weight: bold;
            color: #555;
        }

        .bill ul {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }

        .bill ul li {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dotted #ddd;
        }

        .bill-total {
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            font-size: 18px;
            color: #2e7d32;
        }

        .note-box {
            background: #e8f5e9;
            border-left: 5px solid #66bb6a;
            padding: 10px 15px;
            margin-top: 15px;
            font-style: italic;
            color: #444;
            border-radius: 4px;
        }

    .status-section {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #eee;
    }

    .status-section label {
        font-weight: bold;
        color: #555;
        margin-right: 10px;
    }

    .status-checkbox {
        transform: scale(1.5);
        margin-right: 5px;
        cursor: pointer;
    }

    .status-indicator {
        position: absolute;
        top: 15px;
        left: 20px;
        padding: 5px 10px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

        p {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>

    <div class="filters">
        <label for="orderDate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
        <input type="date" id="orderDate">
    <button id="showAllBtn" class="active">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="showPendingBtn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    <button id="showCompletedBtn">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    </div>

    <div id="orders"></div>

    <script>
        // **‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Backend ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì Deploy ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô https://your-backend-app.onrender.com)**
        const BACKEND_URL = 'https://suwanwet-backend.onrender.com'; // ‡πÉ‡∏ä‡πâ localhost ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Deploy ‡∏à‡∏£‡∏¥‡∏á

        const ordersContainer = document.getElementById('orders');
        const orderDateInput = document.getElementById('orderDate');
    const showAllBtn = document.getElementById('showAllBtn');
    const showPendingBtn = document.getElementById('showPendingBtn');
    const showCompletedBtn = document.getElementById('showCompletedBtn');

        let allOrders = []; // ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Backend ‡πÅ‡∏ó‡∏ô localStorage
    let currentFilterStatus = 'all'; 

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        async function displayOrders() {
            ordersContainer.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...</p>';

        try {
            const response = await fetch(`${BACKEND_URL}/api/admin/orders`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            allOrders = await response.json(); 
        } catch (error) {
            console.error('Error fetching orders:', error);
            ordersContainer.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>';
            return;
        }


            let filteredOrdersByDate = allOrders;
      const dateFilterValue = orderDateInput.value;

            if (dateFilterValue) {
                const selectedDate = new Date(dateFilterValue);
                selectedDate.setHours(0, 0, 0, 0); 
                
                filteredOrdersByDate = allOrders.filter(order => {
                    const orderDateTime = new Date(order.time);
                    orderDateTime.setHours(0, 0, 0, 0); 
                    return orderDateTime.getTime() === selectedDate.getTime();
                });
            }

      let finalFilteredOrders = filteredOrdersByDate.filter(order => {
          if (currentFilterStatus === 'all') {
              return true;
          }
          return order.status === currentFilterStatus;
      });

      ordersContainer.innerHTML = ''; // Clear container before rendering

            if (finalFilteredOrders.length === 0) {
                let message = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
        if (currentFilterStatus === 'pending') {
            message += "‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à";
        } else if (currentFilterStatus === 'completed') {
            message += "‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
        }
        if (dateFilterValue) {
            message += ` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(dateFilterValue).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' })}`; 
        }
        ordersContainer.innerHTML = `<p>${message}</p>`;
                return;
            }
            finalFilteredOrders.sort((a, b) => {
                if (a.status === 'pending' && b.status === 'completed') return -1;
                if (a.status === 'completed' && b.status === 'pending') return 1;
                return new Date(b.time) - new Date(a.time); 
            });

            finalFilteredOrders.forEach(order => {
                let total = 0;
                const bill = document.createElement("div");
                bill.className = `bill ${order.status}`; 

                const itemsHTML = order.items.map(item => {
                    const itemTotal = item.qty * item.price;
                    total += itemTotal;
                    return `<li><span>${item.name} ${item.qty} ‡∏ä‡∏¥‡πâ‡∏ô</span> <span>${itemTotal}‡∏ø</span></li>`; 
                }).join("");

                bill.innerHTML = `
                <div class="status-indicator">
                ${order.status === 'pending' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à' : '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'}
                </div>
                    <h3>üßæ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order._id.substring(order._id.length - 6)}</h3> ¬† ¬† ¬† ¬† ¬† <div class="bill-info">
                        <div><span>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á:</span> <span>${new Date(order.time).toLocaleString('th-TH')}</span></div>
                        <div><span>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á:</span> <span>${order.pickupTime || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"}</span></div>
                    </div>
                    <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</h4>
                    <ul>${itemsHTML}</ul>
                    <div class="bill-total">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ø</div>
                    ${order.note?.trim() ? `<div class="note-box">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${order.note}</div>` : ""}
                <div class="status-section">
                    <label for="status-${order._id}">‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß:</label>
                    <input type="checkbox" 
                        id="status-${order._id}" 
                        class="status-checkbox" 
                        ${order.status === 'completed' ? 'checked' : ''} 
                        onchange="toggleOrderStatus('${order._id}', this.checked)">
                </div>
                `;

                ordersContainer.appendChild(bill);
            });
        }

    async function toggleOrderStatus(orderId, isChecked) {
        const newStatus = isChecked ? 'completed' : 'pending';
        try {
            const response = await fetch(`${BACKEND_URL}/api/admin/orders/${orderId}/status`, {
                method: 'PUT', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï allOrders ‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                displayOrders(); 
            } else {
                const errorData = await response.json();
                alert(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ${errorData.message || response.statusText}`);
                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ checkbox ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
                document.getElementById(`status-${orderId}`).checked = !isChecked; 
            }
        } catch (error) {
            console.error('Error updating order status:', error);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            document.getElementById(`status-${orderId}`).checked = !isChecked; 
        }
    }

    function setActiveButton(buttonId) {
        showAllBtn.classList.remove('active');
        showPendingBtn.classList.remove('active');
        showCompletedBtn.classList.remove('active');
        document.getElementById(buttonId).classList.add('active');
    }

        orderDateInput.addEventListener('change', () => {
        displayOrders();
        });

    showAllBtn.addEventListener('click', () => {
        currentFilterStatus = 'all';
        setActiveButton('showAllBtn');
        displayOrders();
    });

    showPendingBtn.addEventListener('click', () => {
        currentFilterStatus = 'pending';
        setActiveButton('showPendingBtn');
        displayOrders();
    });

    showCompletedBtn.addEventListener('click', () => {
        currentFilterStatus = 'completed';
        setActiveButton('showCompletedBtn');
        displayOrders();
    });

        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        orderDateInput.value = `${year}-${month}-${day}`;

        displayOrders(); 
    </script>
</body>
</html>